# IR阵列定位辅助生成工具

用于在3D曲面模型上布置IR（红外）阵列点位，计算测地线连接路径，生成FPC走线凹槽，并将曲面展开为2D平面用于FPC柔性电路板制造。

## 功能特性

- **3D模型加载**：支持 STL、3MF、OBJ、PLY、OFF 格式（通过 trimesh 自动修复）
- **交互式点选**：在模型表面点击添加IR点位
- **测地线路径**：基于 Dijkstra 算法计算曲面上的最短路径连接
- **凹槽生成**：
  - 沿路径生成可调参数的FPC走线凹槽
  - 支持方形焊盘凹槽（IR点位置）
  - 曲面贴合凹槽，顶部与曲面完美贴合
  - 支持多沟槽交叉（使用布尔并集正确合并）
- **曲面展开**：LSCM（最小二乘共形映射）算法，保持角度精度
- **FPC图纸生成**：自动生成2D FPC布局图纸
- **多格式导出**：DXF、SVG、STL、项目配置JSON

## 安装

### 依赖安装

```bash
pip install -r requirements.txt
```

或手动安装：

```bash
pip install pyqt5 pyvista pyvistaqt trimesh numpy scipy ezdxf numpy-stl networkx manifold3d potpourri3d
```

### 运行

```bash
python main.py
```

或使用启动脚本（自动创建虚拟环境）：

```bash
./run.sh
```

## 使用指南

### 1. 加载3D模型

- 点击菜单 **文件 → 打开模型** (快捷键 `Ctrl+O`)
- 选择 STL/3MF/OBJ 格式的3D模型文件
- 模型将显示在3D视图中，可用鼠标旋转/缩放/平移查看

### 2. 添加IR点位

1. 点击右侧面板的 **"添加点"** 按钮（按钮变红表示进入添加模式）
2. 将鼠标移到模型表面，**按 `P` 键**即可在该位置添加点
3. 点位会显示为绿色球体
4. 继续按 `P` 键可添加更多点
5. 再次点击"添加点"按钮退出添加模式

> **注意**：只能在朝向你的表面添加点，背面会被自动忽略

### 2.5 选择和编辑IR点

- **按 `P` 键点击**已有的IR点可以选中它（显示黄色高亮）
- 选中后可在右侧面板编辑名称、分组
- 在点列表中点击也会同步高亮3D视图中的点

### 3. 设置中心连接点

- **双击**点列表中的某个点，将其设为中心连接点
- 或选中点后点击 **"设为中心连接点"** 按钮
- 中心点显示为红色，所有其他点将连接到此点

### 4. 生成连接路径

- 点击 **"生成连接路径"** 按钮
- 系统自动计算所有IR点到中心点的测地线最短路径
- 路径显示为橙色线条

### 5. 生成凹槽

1. 切换到右下方的 **"凹槽"** 选项卡
2. 调整参数：
   - **基础宽度**：凹槽宽度 (mm)
   - **凹槽深度**：凹槽深度 (mm)
   - **自动调整宽度**：根据汇聚线路数量自动加宽
   - **方形焊盘**：在IR点位置生成方形焊盘凹槽
   - **焊盘尺寸**：方形焊盘的长度和宽度
3. 点击 **"生成凹槽预览"**
4. 凹槽显示为紫色半透明
5. 系统会尝试将凹槽应用到3D模型（需要 manifold3d 或 Blender 引擎）

> **提示**：多条沟槽交叉时会自动使用布尔并集合并，确保交叉部分正确切割。

### 6. 曲面展开

1. 切换到 **"展开"** 选项卡
2. 点击 **"展开曲面"**
3. 系统使用LSCM算法将曲面展开为2D
4. 显示变形量信息

### 7. 生成FPC图纸

1. 在生成凹槽和展开曲面后
2. 点击 **"生成FPC图纸"** 按钮
3. 系统自动生成2D FPC布局，包含：
   - 凹槽轮廓
   - IR点焊盘（方形或圆形）
   - 中心点焊盘
   - 合并后的外轮廓

### 8. 导出文件

1. 切换到 **"导出"** 选项卡
2. 点击 **"浏览..."** 选择输出目录
3. 勾选需要导出的文件类型
4. 点击 **"一键保存所有文件"**

导出文件包括：
- `ir_array_original.stl` - 原始3D模型
- `ir_array_with_grooves.stl` - 带凹槽的3D模型
- `ir_array_2d_paths.dxf` - 2D展开路径（用于FPC制造）
- `ir_array_project.json` - 项目配置文件

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+O` | 打开模型 |
| `Ctrl+S` | 保存项目 |
| `Ctrl+E` | 导出所有 |
| `P` | 在鼠标位置添加IR点（需先开启添加模式）|
| 鼠标左键拖动 | 旋转视图 |
| 鼠标中键拖动 | 平移视图 |
| 鼠标滚轮 | 缩放视图 |

## 3D视图操作

- **旋转**：按住鼠标左键拖动
- **平移**：按住鼠标中键拖动，或 Shift + 左键拖动
- **缩放**：滚动鼠标滚轮，或按住鼠标右键上下拖动

## 项目结构

```
ir_array_tool/
├── main.py                 # 程序入口
├── requirements.txt        # 依赖列表
├── run.sh                  # 启动脚本
├── README.md               # 本文件
├── CLAUDE.md               # Claude Code 开发指南
├── ui/
│   ├── main_window.py      # 主窗口
│   ├── viewer_3d.py        # 3D视图组件 (PyVista)
│   ├── view_2d.py          # 2D展开视图
│   ├── point_panel.py      # 点位管理面板
│   ├── param_panel.py      # 参数设置面板
│   └── coord_panel.py      # 坐标显示面板
├── core/
│   ├── mesh_loader.py      # 模型加载 (trimesh)
│   ├── geodesic.py         # 测地线路径计算 (Dijkstra)
│   ├── groove_gen.py       # 凹槽生成（支持方形焊盘）
│   ├── conformal_map.py    # LSCM共形映射展开
│   ├── path_planner_2d.py  # 2D路径规划
│   ├── path_flatten.py     # 路径展平
│   └── exporter.py         # 文件导出 (DXF/SVG/STL)
└── utils/
    └── geometry.py         # 几何工具函数
```

## 技术说明

### 测地线计算
使用基于Dijkstra算法的网格最短路径计算，在三角网格的边上寻找最短路径。

### 共形映射展开
使用LSCM（最小二乘共形映射）算法，保持局部角度不变，适合FPC柔性电路板的平面化制造。

### 凹槽生成
- 沿测地线路径生成矩形截面的凹槽几何体
- 支持曲面贴合（凹槽顶部与曲面完美贴合）
- 支持自适应宽度（根据汇聚线路数量自动加宽）
- 支持方形焊盘凹槽（在IR点位置）
- 多沟槽交叉时使用布尔并集(union)合并，确保交叉部分正确切割

### 布尔运算引擎
支持两种布尔运算引擎：
- **manifold3d**（推荐）：高性能几何内核，`pip install manifold3d`
- **Blender**：需要安装 Blender 并确保可从命令行调用

## 常见问题

### Q: 点击模型无法添加点？
A:
1. 确保已点击"添加点"按钮（按钮变红表示添加模式已开启）
2. 将鼠标悬停在模型表面上
3. 按下键盘 `P` 键添加点
4. 如果还是无法添加，尝试调整视角让模型表面朝向你

### Q: 加载模型失败？
A: 检查模型文件是否损坏，尝试使用其他软件（如 MeshLab）打开并重新保存。

### Q: 路径生成失败？
A: 确保已设置中心连接点（双击列表中的点），且至少有2个IR点。

### Q: 凹槽交叉部分没有正确切割？
A: 确保已安装 manifold3d (`pip install manifold3d`) 或 Blender。程序会自动使用布尔并集合并所有凹槽后再执行差集运算。

### Q: 布尔运算失败？
A:
1. 安装 manifold3d：`pip install manifold3d`
2. 或安装 Blender 并确保可从命令行调用
3. 凹槽预览会正常显示，但无法应用到导出的3D模型

## 许可证

MIT License
